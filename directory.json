{
  "directory": [
    {
      "name": "matrix-message",
      "description": "Send a message to a matrix channel",
      "author": "Martin Pugh (pugh@s3kr.it)",
      "inputs": {
        "server": {
          "description": "Matrix server hostname",
          "default": "matrix.org",
          "required": false
        },
        "room_id": {
          "description": "Matrix room ID, specified in channels advanced settings",
          "default": "",
          "required": true
        },
        "access_token": {
          "description": "Access token required to send to matrix server",
          "default": "",
          "required": true
        },
        "message": {
          "description": "Message to send in plaintext format",
          "default": "",
          "required": true
        }
      },
      "runs": {
        "using": "docker",
        "image": "Dockerfile"
      },
      "branding": {
        "icon": "message-square",
        "color": "gray-dark"
      }
    },
    {
      "name": "Download",
      "description": "Download artifacts",
      "author": "Wilfried Kopp <chevdor@gmail.com>",
      "branding": {
        "icon": "package",
        "color": "blue"
      },
      "inputs": {
        "chain": {
          "description": "Name of the chain, ie. polkadot\n",
          "required": true
        }
      },
      "outputs": {
        "json": {
          "description": "Foobar\n",
          "value": "${{ steps.build.outputs.json }}"
        }
      },
      "runs": {
        "using": "composite",
        "steps": [
          {
            "id": "foo",
            "name": "Foo",
            "shell": "bash",
            "run": "echo FOO\n"
          }
        ]
      }
    },
    {
      "name": "Upload",
      "description": "Upload artifacts",
      "author": "Wilfried Kopp <chevdor@gmail.com>",
      "branding": {
        "icon": "package",
        "color": "green"
      },
      "inputs": {
        "AWS_ACCESS_KEY_ID": {
          "description": "The AWS Key to be used. Make sure it has the required access rights",
          "required": true
        },
        "AWS_SECRET_ACCESS_KEY": {
          "description": "The AWS secret key",
          "required": true
        },
        "AWS_BUCKET": {
          "description": "AWS Bucket",
          "required": true
        },
        "AWS_REGION": {
          "description": "The AWS region",
          "required": true
        },
        "public": {
          "description": "NOT IMPLEMENTED YET Whether the artifacts should be uploaded as public or not. Please note that some backends do not allow private uploads.\n",
          "default": "false",
          "required": true
        },
        "product": {
          "description": "Project",
          "required": true
        },
        "arch": {
          "description": "arch",
          "required": false
        },
        "version": {
          "description": "version",
          "required": true
        },
        "file_name": {
          "description": "input file",
          "required": true
        },
        "target_path": {
          "description": "Target path",
          "required": true
        },
        "labels": {
          "description": "NOT IMPLEMENTED YET An array of labels\n",
          "required": false
        },
        "overwrite": {
          "description": "Allows overwriting if the file already exists\n",
          "required": false,
          "default": "false"
        },
        "md5": {
          "description": "NOT IMPLEMENTED YET Should generate a md5 checksum ?\n",
          "default": "false"
        },
        "sha256": {
          "description": "NOT IMPLEMENTED YET Should generate a sha256 checksum ?\n",
          "default": "false"
        },
        "image": {
          "description": "Docker image to be used. This is usually not something you want to change unless you know what you are doing\n",
          "required": true,
          "default": "paritytech/releng-scripts"
        }
      },
      "outputs": {
        "url": {
          "description": "URL of the uploaded artifact\n",
          "value": "${{ steps.upload.outputs.json }}"
        }
      },
      "runs": {
        "using": "composite",
        "steps": [
          {
            "name": "Fetch Docker image",
            "shell": "bash",
            "env": {
              "IMAGE": "${{ inputs.image }}"
            },
            "run": "docker pull $IMAGE\n# docker images\ndocker run --rm paritytech/releng-scripts version\n"
          },
          {
            "name": "Upload ${{ inputs.file_name }}",
            "id": "upload",
            "env": {
              "IMAGE": "${{ inputs.image }}",
              "FILE": "${{ inputs.file_name }}",
              "AWS_ACCESS_KEY_ID": "${{ inputs.AWS_ACCESS_KEY_ID }}",
              "AWS_SECRET_ACCESS_KEY": "${{ inputs.AWS_SECRET_ACCESS_KEY }}",
              "AWS_REGION": "${{ inputs.AWS_REGION }}",
              "AWS_BUCKET": "${{ inputs.AWS_BUCKET }}",
              "PRODUCT": "${{ inputs.product }}",
              "ARCH": "${{ inputs.arch }}",
              "VERSION": "${{ inputs.version }}",
              "OVERWRITE": "${{inputs.overwrite}}"
            },
            "shell": "bash",
            "run": "shopt -s expand_aliases\nVOL=/data\n\nalias rs=\"docker run --rm -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_REGION -e AWS_BUCKET -v $PWD:$VOL $IMAGE\"\nalias awscli=\"docker run --rm  -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_REGION -e AWS_BUCKET -e AWS_CONFIG_FILE paritytech/awscli\"\necho \"Running image version: $(rs version)\"\necho \"Overwrite: ${OVERWRITE}\"\n\nif [[ \"$OVERWRITE\" == \"true\" ]]; then\n  OVERWRITE_ARGS=\" --overwrite \"\nelse\n  OVERWRITE_ARGS=\"\"\nfi\n\nif [[ ! -z \"$ARCH\" ]]; then\n  upload_path=\"${PRODUCT}/${VERSION}/${ARCH}\"\nelse\n  upload_path=\"${PRODUCT}/${VERSION}\"\nfi\necho \"upload_path: $upload_path\"\n\nls -al\necho \"Upload of $FILE\"\nrs upload ${OVERWRITE_ARGS} \\\n  --bucket \"${AWS_BUCKET}\" \\\n  custom \\\n  ${upload_path} \\\n  s3 \\\n  \"$VOL/${FILE}\"\n\n# TODO: we don't want to see ALL\necho \"Check: https://${AWS_BUCKET}.s3.${AWS_DEFAULT_REGION}.amazonaws.com/index.html\"\nawscli aws s3 ls ${AWS_BUCKET} --summarize\nawscli aws s3 ls ${AWS_BUCKET} --human-readable --recursive\n"
          }
        ]
      }
    }
  ]
}
